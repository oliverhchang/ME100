// File: code_Controller_ESP32_Remote.ino

#include <esp_now.h>
#include <WiFi.h>

#include "shared_struct.h" // Our shared command list

// *** REPLACE with your MAIN ESP32's MAC Address ***
uint8_t mainEsp32Address[] = {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF};

esp_now_peer_info_t peerInfo;
struct_message messageToSend;

// === 1. HARDWARE STUBS (Your code goes here) ===
const int START_BUTTON_PIN = 12;
const int RICE_SELECT_PIN = 13;
const int PORTION_UP_PIN = 14;

// Global variables to track settings
int currentRiceType = 1;
int currentPortion = 150; // default 150g

// === 2. ESP-NOW FUNCTIONS ===

// Callback when data is sent
void OnDataSent(const uint8_t *mac_addr, esp_now_send_status_t status) {
  Serial.print("Last Packet Send Status: ");
  Serial.println(status == ESP_NOW_SEND_SUCCESS ? "Delivery Success" : "Delivery Fail");
}

// Helper function to send a command
void sendCommand(CommandType cmd, int val) {
  messageToSend.command = cmd;
  messageToSend.value = val;
  esp_err_t result = esp_now_send(mainEsp32Address, (uint8_t *) &messageToSend, sizeof(messageToSend));
  
  if (result != ESP_OK) {
    Serial.println("Error sending command");
  }
}

void setup() {
  Serial.begin(115200);
  
  // Set button pins
  pinMode(START_BUTTON_PIN, INPUT_PULLUP);
  pinMode(RICE_SELECT_PIN, INPUT_PULLUP);
  pinMode(PORTION_UP_PIN, INPUT_PULLUP);

  // Set device as a Wi-Fi Station (needed for ESP-NOW)
  WiFi.mode(WIFI_STA);

  // Init ESP-NOW
  if (esp_now_init() != ESP_OK) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }

  // Register the send callback
  esp_now_register_send_cb(OnDataSent);
  
  // Register the peer (the Main ESP32)
  memcpy(peerInfo.peer_addr, mainEsp32Address, 6);
  peerInfo.channel = 0;  
  peerInfo.encrypt = false;
  if (esp_now_add_peer(&peerInfo) != ESP_OK){
    Serial.println("Failed to add peer");
    return;
  }
  Serial.println("Controller ESP32 (Remote) Ready.");
  Serial.printf("Current settings: Rice %d, Portion %dg\n", currentRiceType, currentPortion);
}

void loop() {
  // Check for Start Button
  if (digitalRead(START_BUTTON_PIN) == LOW) {
    Serial.println("Start button pressed. Sending START command...");
    // First, send the settings, then send the start command
    sendCommand(CMD_SELECT_RICE_TYPE, currentRiceType);
    delay(50); // Small delay between messages
    sendCommand(CMD_SET_PORTION, currentPortion);
    delay(50);
    sendCommand(CMD_START_PROCESS, 0);
    
    delay(500); // Debounce
  }

  // Check for Rice Select Button
  if (digitalRead(RICE_SELECT_PIN) == LOW) {
    currentRiceType++;
    if (currentRiceType > 3) { // Assuming 3 rice types
      currentRiceType = 1;
    }
    Serial.printf("Rice type set to: %d\n", currentRiceType);
    // TODO: You could add a small display (OLED) here to show this
    delay(300); // Debounce
  }

  // Check for Portion Up Button
  if (digitalRead(PORTION_UP_PIN) == LOW) {
    currentPortion += 50; // Increase by 50g
    if (currentPortion > 500) { // Max 500g
      currentPortion = 150; // Loop back
    }
    Serial.printf("Portion set to: %dg\n", currentPortion);
    delay(300); // Debounce
  }
}
